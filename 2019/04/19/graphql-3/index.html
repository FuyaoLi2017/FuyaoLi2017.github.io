<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Merriweather:300,300italic,400,400italic,700,700italic|Merriweather:300,300italic,400,400italic,700,700italic|Merriweather:300,300italic,400,400italic,700,700italic|Lemon:300,300italic,400,400italic,700,700italic|Bitter:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/photo.jpeg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/photo.jpeg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/photo.jpeg?v=5.1.4">


  <link rel="mask-icon" href="/images/photo.jpeg?v=5.1.4" color="#222">





  <meta name="keywords" content="Computer Science,ardent academy,JavaScript,">





  <link rel="alternate" href="/atom.xml" title="Fuyao Li" type="application/atom+xml">






<meta name="description" content="3.1 PatternsGraphQL queries consist of one or more patterns which are matched agianst the big graph containing all the data on the server. A pattern is expressed in terms of the relationships between">
<meta name="keywords" content="Computer Science,ardent academy,JavaScript">
<meta property="og:type" content="article">
<meta property="og:title" content="GraphQL-3 GraphQL query language">
<meta property="og:url" content="http://fuyaoli.me/2019/04/19/graphql-3/index.html">
<meta property="og:site_name" content="Fuyao Li">
<meta property="og:description" content="3.1 PatternsGraphQL queries consist of one or more patterns which are matched agianst the big graph containing all the data on the server. A pattern is expressed in terms of the relationships between">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-05-01T22:29:58.809Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="GraphQL-3 GraphQL query language">
<meta name="twitter:description" content="3.1 PatternsGraphQL queries consist of one or more patterns which are matched agianst the big graph containing all the data on the server. A pattern is expressed in terms of the relationships between">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":20,"b2t":true,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://fuyaoli.me/2019/04/19/graphql-3/">





  <title>GraphQL-3 GraphQL query language | Fuyao Li</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Fuyao Li</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Application Engineer @ Oracle, UC Irvine Alumni</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about-fuyao">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            about Fuyao
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-projects">
          <a href="/projects/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tasks"></i> <br>
            
            Projects
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>
            
            Sitemap
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fuyaoli.me/2019/04/19/graphql-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fuyao Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fuyao Li">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">GraphQL-3 GraphQL query language</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-19T15:45:24-07:00">
                2019-04-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/GraphQL/" itemprop="url" rel="index">
                    <span itemprop="name">GraphQL</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/04/19/graphql-3/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/04/19/graphql-3/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/04/19/graphql-3/" class="leancloud_visitors" data-flag-title="GraphQL-3 GraphQL query language">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="3-1-Patterns"><a href="#3-1-Patterns" class="headerlink" title="3.1 Patterns"></a>3.1 Patterns</h2><p>GraphQL queries consist of one or more patterns which are matched agianst the big graph containing all the data on the server.</p>
<p>A pattern is expressed in terms of the relationships between objects and the fields the objects contain.</p>
<p>Multi-level hierarchies can be built because a field can also be an object which contains its own fields.</p>
<h2 id="3-2-GraphQL-methods"><a href="#3-2-GraphQL-methods" class="headerlink" title="3.2 GraphQL methods"></a>3.2 GraphQL methods</h2><ol>
<li><strong>query</strong> is used for retrieval, for reading data(see 3.3)</li>
<li><strong>mutation</strong> is used for modification, for writing data (see 3.4)</li>
<li><strong>subscription</strong> is used for notification of changed data (see 3.5)</li>
</ol>
<h2 id="3-3-GraphQL-Query"><a href="#3-3-GraphQL-Query" class="headerlink" title="3.3 GraphQL Query"></a>3.3 GraphQL Query</h2><p>To read data with graphQL, the client uses the query method.</p>
<p>In the pattern of this query, the client has to explicitly specify all the object and fields it is interested in.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">    books &#123;</span><br><span class="line">        title</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Executing the query might result in the following data, which is returned in JSON format.</li>
<li>For graphQL, query and response have the same shape. The query is comparable to a template in a template language.</li>
<li>Just like functions in JS, queries can be anonymous or named. If a query is given a name, it allows us identify it easier later on.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">query myBookQuery &#123;</span><br><span class="line">    books &#123;</span><br><span class="line">        title</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="3-3-1-Objects"><a href="#3-3-1-Objects" class="headerlink" title="3.3.1 Objects"></a>3.3.1 Objects</h3><ul>
<li>Inside the query method, one or more objects can be retrieved.</li>
<li>An object can not be retrieved without explicitly specifying the fields that should be returned.</li>
</ul>
<h3 id="3-3-2-Fields"><a href="#3-3-2-Fields" class="headerlink" title="3.3.2 Fields"></a>3.3.2 Fields</h3><ul>
<li>Objects have fields of their own, primitives do not.</li>
<li>The types of the fields are objects, array or a primitive type.</li>
<li><p>The query language does not ditinguish between lists and single elements, such as primitives or objects. If the fields is a list, its fields are actually the fields of each element in the list.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">    books &#123;</span><br><span class="line">        title</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>If field has further fields itself, we can create a new level of nesting. The result tree gets deeper.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">    books &#123;</span><br><span class="line">        title</span><br><span class="line">        author [</span><br><span class="line">            name</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="3-3-3-Arguments"><a href="#3-3-3-Arguments" class="headerlink" title="3.3.3 Arguments"></a>3.3.3 Arguments</h3><ul>
<li>An argument is used to put constraints on objects. Only objects which satisfy the constraints imposed by the argument are included in the result.</li>
<li>An argument in GraphQL is comparable to a <strong>WHERE</strong> in SQL.</li>
<li>In graphQL, the arguments are identified and passed in by their name.(id in our example)</li>
</ul>
<h3 id="3-3-4-Alias"><a href="#3-3-4-Alias" class="headerlink" title="3.3.4 Alias"></a>3.3.4 Alias</h3><ul>
<li>To avoid name confilct, we cna rename a fields with an alias.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">    book_by_id (id:&quot;1234&quot;) &#123;</span><br><span class="line">        title</span><br><span class="line">    &#125;</span><br><span class="line">    second_book: book_by_id (id:&quot;5678&quot;) &#123;</span><br><span class="line">        title</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="3-3-5-Fragments"><a href="#3-3-5-Fragments" class="headerlink" title="3.3.5 Fragments"></a>3.3.5 Fragments</h3><ul>
<li>Some queries contain repeating elements. In this case, it is tedious to get consistent in the first palce and tedious to maintain consistency.</li>
<li>Repeating elements of a query can be factored out into socalled fragments.</li>
<li><p>Fragments need to be defined once (using <strong>fragment</strong> keyword) and can be applied mulitple times (using the â€¦ keyword)</p>
<h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><p>We can rewrite the previous example with the following code sample.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">    book_by_id (id:&quot;1234&quot;) &#123;</span><br><span class="line">        ...bookinfo</span><br><span class="line">    &#125;</span><br><span class="line">    second_book: book_by_id (id:&quot;5678&quot;) &#123;</span><br><span class="line">        ...bookinfo</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fragment bookinfo on Book &#123;</span><br><span class="line">    title</span><br><span class="line">    author &#123;</span><br><span class="line">        name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Note, that a fragment is defined for a specific type. (see section 2.3),in our example, the fragment is specific for a Book.</p>
</li>
</ul>
<h3 id="3-3-6-Inline-Fragments"><a href="#3-3-6-Inline-Fragments" class="headerlink" title="3.3.6 Inline Fragments"></a>3.3.6 Inline Fragments</h3><ul>
<li>Inline fragment are used to distinguish different types. It is similar to an <strong>instanceof</strong> operator in OOP languages.</li>
<li>Inline fragments are for ploymorphism, i.e. for <strong>interface</strong> and <strong>union</strong> types.</li>
<li>With inline fragments, we can check the type of an object at runtime.</li>
</ul>
<h4 id="Example-of-using-inline-fragment-in-interface"><a href="#Example-of-using-inline-fragment-in-interface" class="headerlink" title="Example of using inline fragment in interface"></a>Example of using inline fragment in interface</h4><ul>
<li>To access the private-owned fields of implementation type of interfaces. We need to use inline fragments.</li>
<li><p>We first define an interface and two implementation types.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">interface Document &#123;</span><br><span class="line">    title: String,</span><br><span class="line">    text: String,</span><br><span class="line">    authors: [Author]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Book implements Document &#123;</span><br><span class="line">    id: ID!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Article implements Document &#123;</span><br><span class="line">    magazine: String!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Query &#123;</span><br><span class="line">    readingList: [Document]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>If we want to access the id field for Book or magazine field for article, we need to specify which type it really belongs to, we need to use inline fragment in this case.</p>
</li>
<li><p>The query format should be as follows.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">    readingList &#123;</span><br><span class="line">        title</span><br><span class="line">        text</span><br><span class="line">        authors&#123;</span><br><span class="line">            name</span><br><span class="line">        &#125;</span><br><span class="line">        ... on Book &#123;</span><br><span class="line">            id</span><br><span class="line">        &#125;</span><br><span class="line">        ... on Article &#123;</span><br><span class="line">            magazine</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>For interfaces, we use use inline fragments to access additional fields.</p>
</li>
<li>For union types, since a union in general share no fields. Inline fragment have to be used for accessing any fields in a union.</li>
</ul>
<h3 id="3-3-7-Variables"><a href="#3-3-7-Variables" class="headerlink" title="3.3.7 Variables"></a>3.3.7 Variables</h3><ul>
<li>Variables can be used to pass different values into a query. When this value needs to be changed, the query itself can stay as it is.</li>
<li><p>Format <code>{$variable name}: {type of the bookID}[!,nothing(means whether this is a required parameter)] [= default value]</code> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">query getSpecificBook ($BookID: String = &quot;1234&quot;) &#123;</span><br><span class="line">    book_by_id (id: $bookID) &#123;</span><br><span class="line">        title</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Variable need to have a type (primitive or object type)</p>
</li>
</ul>
<h3 id="3-3-8-Directives"><a href="#3-3-8-Directives" class="headerlink" title="3.3.8 Directives"></a>3.3.8 Directives</h3><ul>
<li>Directives can be used to dynamically include or exclude a part of a query.</li>
<li>Dynamically means depending on the value of boolean variable. This boolean variable has to be decleared just like any other variables.</li>
<li>There are two types of directives: one to include (@include keyword) a part of the query and one to exclude (@skip keywords) a part of the query.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">query getBooks($flag: boolean) &#123;</span><br><span class="line">    books&#123;</span><br><span class="line">        title</span><br><span class="line">        id @include(if: $flag)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>The above examples includes the id fields only if the value <code>$flag</code> is <code>true</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">query getBooks($flag: boolean) &#123;</span><br><span class="line">    books&#123;</span><br><span class="line">        title</span><br><span class="line">        id @skip(if: $flag)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The above example is the reverse meaning for the first example.</p>
<h2 id="3-4-GraphQL-mutations"><a href="#3-4-GraphQL-mutations" class="headerlink" title="3.4 GraphQL mutations"></a>3.4 GraphQL mutations</h2><ul>
<li>The mutation method is used for modifying, adding or writing data on the server with GraphQL.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mutation &#123;</span><br><span class="line">    addBook (title: &quot;New Book&quot;) &#123;</span><br><span class="line">        id</span><br><span class="line">        title</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="3-5-GraphQL-Subscirption"><a href="#3-5-GraphQL-Subscirption" class="headerlink" title="3.5 GraphQL Subscirption"></a>3.5 GraphQL Subscirption</h2><ul>
<li>Modern clients need to get near real-time updates that get triggered when something changes on the server.</li>
<li>REST does not provide any built-in support for such notifications from the server; thus notifications are often realized by polling or by webhooks. You can refer more details about webhooks in the below resources.</li>
</ul>
<blockquote>
<p>Book, Webhooks - Events for REST APIs</p>
</blockquote>
<blockquote>
<p><a href="https://sendgrid.com/blog/whats-webhook/" target="_blank" rel="noopener">https://sendgrid.com/blog/whats-webhook/</a></p>
</blockquote>
<ul>
<li>With polling, the client periodically sends requests to the server. The client usually needs to poll on an endpoint that returns a list of elements and compares the retrieved list against the previously retrieved list in order to find the new elements.(expensive operation)</li>
<li>With webhooks, the server calls the client, whenever the resources becomes available. To set this up, the client first needs to register an endpoint that gets called by the server. The client needs to be able to expose this endpoint that can receive the events.</li>
</ul>
<h3 id="GraphQL-implementation"><a href="#GraphQL-implementation" class="headerlink" title="GraphQL implementation"></a>GraphQL implementation</h3><ul>
<li>GraphQL offers subscriptions as a built-in mechanism for realizing notifications.</li>
<li><p>First step: client need to send a subscription request to the graphQL API. The request specfies both the event to observe and the data.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">subscription &#123;</span><br><span class="line">    bookAdded &#123;</span><br><span class="line">        id</span><br><span class="line">        title</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>When to trigger?</p>
<ul>
<li>In most cases, notification is triggered by a modification of the data inside the graph, i.e. mutation. This means an event handler needs to be installed inside the implementation of the mutation.</li>
<li>In rare cases, notifcation can be triggered by an external event, which is direclty accessible inside the graph or only accessible in aggregated form. An example is sensor data, of which a single measurement may be used as a trigger, whereas the graph only contains aggredated sensor data and no single measurements.</li>
</ul>
</li>
</ul>
<h2 id="I-still-have-some-questions-regarding-how-to-implement-the-Subscriptions-with-GraphQL-Remaining-to-be-explored"><a href="#I-still-have-some-questions-regarding-how-to-implement-the-Subscriptions-with-GraphQL-Remaining-to-be-explored" class="headerlink" title="I still have some questions regarding how to implement the Subscriptions with GraphQL! Remaining to be explored!"></a>I still have some questions regarding how to implement the Subscriptions with GraphQL! Remaining to be explored!</h2>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Computer-Science/" rel="tag"># Computer Science</a>
          
            <a href="/tags/ardent-academy/" rel="tag"># ardent academy</a>
          
            <a href="/tags/JavaScript/" rel="tag"># JavaScript</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/04/14/graphql-2/" rel="next" title="GraphQL-2 GraphQL Schema Language">
                <i class="fa fa-chevron-left"></i> GraphQL-2 GraphQL Schema Language
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/05/01/graphql-4/" rel="prev" title="GraphQL-4 Building A GraphQL API">
                GraphQL-4 Building A GraphQL API <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/uploads/avatar.jpeg" alt="Fuyao Li">
            
              <p class="site-author-name" itemprop="name">Fuyao Li</p>
              <p class="site-description motion-element" itemprop="description">Backend / Big data / Frontend / DevOps</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/FuyaoLi2017" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:fuyaol@uci.edu" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.facebook.com/profile.php?id=100011662450628" target="_blank" title="Facebook">
                      
                        <i class="fa fa-fw fa-facebook"></i>Facebook</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.linkedin.com/in/fuyaoli/" target="_blank" title="Linkedin">
                      
                        <i class="fa fa-fw fa-linkedin"></i>Linkedin</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-Patterns"><span class="nav-number">1.</span> <span class="nav-text">3.1 Patterns</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-GraphQL-methods"><span class="nav-number">2.</span> <span class="nav-text">3.2 GraphQL methods</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-GraphQL-Query"><span class="nav-number">3.</span> <span class="nav-text">3.3 GraphQL Query</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-1-Objects"><span class="nav-number">3.1.</span> <span class="nav-text">3.3.1 Objects</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-2-Fields"><span class="nav-number">3.2.</span> <span class="nav-text">3.3.2 Fields</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-3-Arguments"><span class="nav-number">3.3.</span> <span class="nav-text">3.3.3 Arguments</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-4-Alias"><span class="nav-number">3.4.</span> <span class="nav-text">3.3.4 Alias</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-5-Fragments"><span class="nav-number">3.5.</span> <span class="nav-text">3.3.5 Fragments</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Example"><span class="nav-number">3.5.1.</span> <span class="nav-text">Example</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-6-Inline-Fragments"><span class="nav-number">3.6.</span> <span class="nav-text">3.3.6 Inline Fragments</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Example-of-using-inline-fragment-in-interface"><span class="nav-number">3.6.1.</span> <span class="nav-text">Example of using inline fragment in interface</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-7-Variables"><span class="nav-number">3.7.</span> <span class="nav-text">3.3.7 Variables</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-8-Directives"><span class="nav-number">3.8.</span> <span class="nav-text">3.3.8 Directives</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-GraphQL-mutations"><span class="nav-number">4.</span> <span class="nav-text">3.4 GraphQL mutations</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-GraphQL-Subscirption"><span class="nav-number">5.</span> <span class="nav-text">3.5 GraphQL Subscirption</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GraphQL-implementation"><span class="nav-number">5.1.</span> <span class="nav-text">GraphQL implementation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#I-still-have-some-questions-regarding-how-to-implement-the-Subscriptions-with-GraphQL-Remaining-to-be-explored"><span class="nav-number">6.</span> <span class="nav-text">I still have some questions regarding how to implement the Subscriptions with GraphQL! Remaining to be explored!</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Fuyao Li</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://fuyaoli-me.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://fuyaoli.me/2019/04/19/graphql-3/';
          this.page.identifier = '2019/04/19/graphql-3/';
          this.page.title = 'GraphQL-3 GraphQL query language';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://fuyaoli-me.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("oyVGHDUiweJcdb6f77vUF4CB-gzGzoHsz", "JGy6gqvMiCEed9xS4df4WvQA");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
